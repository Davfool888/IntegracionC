language: python
python:
  - "3.9"

services:
  - docker

# Instalar dependencias de Python para el backend
install:
  - pip install -r backend/requirements.txt

# Antes de las pruebas, construir imágenes Docker
before_script:
  - docker-compose build

script:
  # 1️⃣ Ejecutar pruebas unitarias del backend
  - echo "Ejecutando pruebas unitarias del backend..."
  - python -m unittest discover backend/tests

  # 2️⃣ Levantar backend y frontend en contenedores Docker
  - echo "Levantando contenedores para prueba integrada..."
  - docker-compose up -d
  - sleep 8  # tiempo para que se inicialicen correctamente

  # 3️⃣ Validar que el backend responde
  - echo "Verificando backend en http://localhost:5000/ ..."
  - curl -f http://localhost:5000/ || (echo "ERROR: Backend no responde" && exit 1)

  # 4️⃣ Validar que el frontend responde
  - echo "Verificando frontend en http://localhost:80/ ..."
  - curl -f http://localhost:80/ || (echo "ERROR: Frontend no responde" && exit 1)

  # 5️⃣ Listar contenedores activos (opcional, para debugging)
  - docker ps

# Después de las pruebas, cerrar los contenedores
after_script:
  - docker-compose down

# Opcional: notificaciones por email
notifications:
  email:
    recipients:
      - tu-email@ejemplo.com
    on_success: change
    on_failure: always
